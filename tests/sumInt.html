<!DOCTYPE html>
<html>
<head>
<style>
textarea {
  width: 640px;
}
</style>
<script id="js_code">
function jsSumInt(array, n) {
  var s = 0;
  for (var i = 0; i < n; i++) {
    s += array[i];
  }
  return s;
}
</script>
<script id="test_code">
function start() {
  var sumIntModule = null;
  var sumIntInstance = null;

  function onEnvReady(dataBuffer) {
    var loop = 100;

    var jsPerformance = document.getElementById('js_performance');
    var wsPerformance = document.getElementById('ws_performance');
    var comparison = document.getElementById('comparison');

    jsPerformance.innerText = '';
    wsPerformance.innerText = '';
    comparison.innerText = '';

    var array = new Int32Array(dataBuffer);

    function initArray(array) {
      for (var i = 0, il = array.length; i < il; i++) {
        array[i] = ((Math.random() * 20000) | 0) - 10000;
      }
    }

    function checkFunctionality(array, n) {
      console.log("trying to check jsSumInt and wsSumInt equality");
      var eq = jsSumInt(array, n) === wsSumInt(array, n);
      console.log("finished checking equality: " + eq);
      return eq;
    }

    function run(func, array, loop) {
      func(array, array.length); // warm-up
      var elapsedTime = 0.0;
      for (var i = 0; i < loop; i++) {
        var startTime = performance.now();
        func(array, array.length);
        var endTime = performance.now();
        elapsedTime += (endTime - startTime);
      }
      return (elapsedTime / loop).toFixed(4);
    }

    function wsSumInt(array, n) {
      return sumIntInstance.exports._sumInt(0, n);
    }

    initArray(array);
    // don't use Promise for the non Promise support browsers so far.
    setTimeout(function () {
      if (! checkFunctionality(array, num)) {
        document.getElementById('message').innerText =
                'Two functions seem not equeal';
        document.getElementById('run_button').disabled = false;
        return;
      }
      setTimeout(function () {
        jsPerformance.innerText = run(jsSumInt, array, loop);
        setTimeout(function () {
          wsPerformance.innerText = run(wsSumInt, array, loop);
          comparison.innerText =
                  (Number(jsPerformance.innerText) /
                          Number(wsPerformance.innerText)).toFixed(4);
          document.getElementById('message').innerText = 'Done';
          document.getElementById('run_button').disabled = false;
        });
        document.getElementById('message').innerText = 'Running WebAssembly';
      });
      document.getElementById('message').innerText = 'Running JavaScript';
    });

    document.getElementById('message').innerText = 'Checking equality';
  }

  document.getElementById('run_button').disabled = true;

  var num = 0x8000000;
  var bytesRequest = num * Int32Array.BYTES_PER_ELEMENT;
  var pageSize = 64 * 1024;  // Constant per definition of a page size: 64KB
  var numPages = Math.floor(bytesRequest / pageSize) + 1;
  var memoryBlock = new WebAssembly.Memory({initial: numPages, maximum: numPages});

  fetch("sumInt.wasm").then(function(result) {
    var binary = result.arrayBuffer();
    binary.then(function(receivedData) {
      var rawReceivedBytes = new Uint8Array(receivedData);
      WebAssembly.instantiate(rawReceivedBytes, {
        "env": {
          memory: memoryBlock
        }
      }).then(function(wasmModule) {
        sumIntModule = wasmModule.module;
        sumIntInstance = wasmModule.instance;

        onEnvReady(memoryBlock.buffer);
      });
    });
  });
}
</script>
<script>
function onReady() {
  console.log("onReady");
  document.getElementById('run_button').disabled = false;
  document.getElementById('message').innerText = 'Ready';
  console.log("onReady done");
}

function init() {
  console.log("init");
  putCode('test_code_area', document.getElementById('test_code').text.trim());
  putCode('js_code_area', document.getElementById('js_code').text.trim());

  loadTextFile('sumInt.c', function(text) {
    putCode('ws_code_area', text.trim());
  });

  loadTextFile('sumInt.sh', function(text) {
    putCode('sh_code_area', text.trim());
  });
  
  console.log("init finished");
}

function loadTextFile(url, callback) {
  var request = new XMLHttpRequest();
  request.open('GET', url);
  request.responseType = 'text';
  request.onload = function (event) {
    callback(request.response);
  };
  request.send();
}

function putCode(textareaId, code) {
  var textarea = document.getElementById(textareaId);
  textarea.value = code;
  textarea.setAttribute('rows', code.split('\n').length);
}

function switchDisplay(div) {
  var textarea = div.getElementsByTagName('textarea')[0];
  var p = div.getElementsByTagName('p')[0];
  p.textContent = p.textContent.slice(2);
  if (textarea.style.display === 'none') {
    textarea.style.display = '';
    p.textContent = '- ' + p.textContent;
  } else {
    textarea.style.display = 'none';
    p.textContent = '+ ' + p.textContent;
  }
}
</script>
</head>
<body onload="init()">
  <div>
    <p>
      <button id="run_button" onclick="start()">run</button>
      <span id="message">Loading WebAssembly</span>
    </p>
    <p>
      Result (average [ms])<br />
      JavaScript: <span id="js_performance"></span><br />
      WebAssembly: <span id="ws_performance"></span><br />
      JavaScript/WebAssembly: <span id="comparison"></span><br />
    </p>
  </div>
  <div>
    <p onclick="switchDisplay(this.parentNode)">+ Test code</p>
    <p><textarea id="test_code_area" readonly style="display:none"></textarea></p>
  </div>
  <div>
    <p onclick="switchDisplay(this.parentNode)">- JavaScript code</p>
    <p><textarea id="js_code_area" readonly></textarea></p>
  </div>
  <div>
    <p onclick="switchDisplay(this.parentNode)">- WebAssembly C code</p>
    <p><textarea id="ws_code_area" readonly></textarea></p>
  </div>
  <div>
    <p onclick="switchDisplay(this.parentNode)">+ WebAssembly Compile shell script</p>
    <p><textarea id="sh_code_area" readonly style="display:none"></textarea></p>
  </div>
  <div>
    <p onclick="switchDisplay(this.parentNode)">+ WebAssembly Instantiation code</p>
    <p><textarea id="ws_instantiate_code_area" readonly style="display:none"></textarea></p>
  </div>
</body>
</html>
